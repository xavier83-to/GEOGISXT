<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal - Fen√≥menos de Remoci√≥n en Masa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(231, 76, 60, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            text-align: center;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: 700px;
        }

        .map-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .data-controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .data-controls h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .layer-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(52, 73, 94, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .layer-toggle:hover {
            background: rgba(52, 73, 94, 0.2);
            transform: translateY(-2px);
        }

        .layer-toggle.active {
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .layer-toggle input[type="checkbox"] {
            margin: 0;
        }

        .map-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex: 1;
        }

        .map-container h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #map {
            height: 520px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .map-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .map-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .map-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1f5582);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .map-btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .map-btn.danger:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }

        .form-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
        }

        .form-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
            background: rgba(255, 255, 255, 1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 70px;
        }

        .coordinates-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .risk-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .risk-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .risk-card.high {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-color: #f44336;
        }

        .risk-card.medium {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-color: #ff9800;
        }

        .risk-card.low {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border-color: #4caf50;
        }

        .risk-card h4 {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .risk-card .value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
        }

        .file-input-label:hover {
            background: linear-gradient(135deg, #8e44ad, #7d3c98);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .file-info {
            margin-top: 8px;
            padding: 6px 8px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 5px;
            color: #27ae60;
            font-size: 11px;
        }

        .btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 600;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 14px;
        }

        .status-message.success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .status-message.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .status-message.show {
            opacity: 1;
        }

        .legend {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .legend h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .form-container {
                max-height: 600px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .coordinates-group {
                grid-template-columns: 1fr;
            }
            
            .layer-controls {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .risk-indicators {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .map-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .map-btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-mountain"></i> Geoportal - Fen√≥menos de Remoci√≥n en Masa</h1>
            <p>Sistema de monitoreo, an√°lisis y gesti√≥n de deslizamientos y movimientos de ladera</p>
        </div>

        <div class="main-layout">
            <div class="map-section">
                <div class="data-controls">
                    <h3><i class="fas fa-layer-group"></i> Capas de Datos Disponibles</h3>
                    <div class="layer-controls">
                        <div class="layer-toggle" data-layer="deslizamiento1999_2003">
                            <input type="checkbox" id="layer1999_2003">
                            <label for="layer1999_2003">Deslizamientos 1999-2003</label>
                        </div>
                        <div class="layer-toggle" data-layer="deslizamiento2003_2010">
                            <input type="checkbox" id="layer2003_2010">
                            <label for="layer2003_2010">Deslizamientos 2003-2010</label>
                        </div>
                        <div class="layer-toggle" data-layer="deslizamiento2010_2015">
                            <input type="checkbox" id="layer2010_2015">
                            <label for="layer2010_2015">Deslizamientos 2010-2015</label>
                        </div>
                        <div class="layer-toggle" data-layer="litologia">
                            <input type="checkbox" id="layerLitologia">
                            <label for="layerLitologia">Litolog√≠a</label>
                        </div>
                        <div class="layer-toggle" data-layer="urbano_dicf">
                            <input type="checkbox" id="layerUrbano">
                            <label for="layerUrbano">√Åreas Urbanas</label>
                        </div>
                    </div>
                </div>

                <div class="map-container">
                    <h2><i class="fas fa-map"></i> Mapa de An√°lisis Geot√©cnico</h2>
                    <div class="map-controls">
                        <button class="map-btn" onclick="getCurrentLocation()">
                            <i class="fas fa-crosshairs"></i> Mi Ubicaci√≥n
                        </button>
                        <button class="map-btn" onclick="toggleHeatmap()">
                            <i class="fas fa-fire"></i> Mapa de Calor
                        </button>
                        <button class="map-btn" onclick="analyzeRisk()">
                            <i class="fas fa-search"></i> An√°lisis de Riesgo
                        </button>
                        <button class="map-btn danger" onclick="clearMap()">
                            <i class="fas fa-trash"></i> Limpiar
                        </button>
                    </div>
                    <div id="map"></div>
                </div>

                <div class="legend">
                    <h4><i class="fas fa-info-circle"></i> Leyenda</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ff4444;"></div>
                        <span>Deslizamientos Hist√≥ricos</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffaa00;"></div>
                        <span>Zonas de Riesgo Alto</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #44ff44;"></div>
                        <span>Zonas de Riesgo Bajo</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4444ff;"></div>
                        <span>√Årea Urbana</span>
                    </div>
                </div>
            </div>

            <div class="form-container">
                <h2><i class="fas fa-exclamation-triangle"></i> Reportar Evento de Remoci√≥n</h2>
                
                <div class="risk-indicators">
                    <div class="risk-card high">
                        <h4>Riesgo √Årea</h4>
                        <div class="value" id="riesgoArea">--</div>
                    </div>
                    <div class="risk-card medium">
                        <h4>Pendiente</h4>
                        <div class="value" id="pendiente">--¬∞</div>
                    </div>
                    <div class="risk-card low">
                        <h4>Estabilidad</h4>
                        <div class="value" id="estabilidad">--</div>
                    </div>
                </div>

                <form id="reportForm">
                    <div class="form-group">
                        <label for="tipoEvento">Tipo de Evento *</label>
                        <select id="tipoEvento" name="tipoEvento" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="deslizamiento">üèîÔ∏è Deslizamiento</option>
                            <option value="derrumbe">‚õ∞Ô∏è Derrumbe</option>
                            <option value="flujo_detritos">üåä Flujo de Detritos</option>
                            <option value="caida_rocas">ü™® Ca√≠da de Rocas</option>
                            <option value="erosion">üåÄ Erosi√≥n</option>
                            <option value="reptacion">üêå Reptaci√≥n</option>
                            <option value="hundimiento">üï≥Ô∏è Hundimiento</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="magnitud">Magnitud del Evento *</label>
                        <select id="magnitud" name="magnitud" required>
                            <option value="">Seleccionar magnitud</option>
                            <option value="muy_pequeno">Muy Peque√±o (&lt;100 m¬≥)</option>
                            <option value="pequeno">Peque√±o (100-1000 m¬≥)</option>
                            <option value="mediano">Mediano (1000-10000 m¬≥)</option>
                            <option value="grande">Grande (10000-100000 m¬≥)</option>
                            <option value="muy_grande">Muy Grande (&gt;100000 m¬≥)</option>
                        </select>
                    </div>

                    <div class="coordinates-group">
                        <div class="form-group">
                            <label for="latitud">Latitud *</label>
                            <input type="number" id="latitud" name="latitud" step="any" required>
                        </div>
                        <div class="form-group">
                            <label for="longitud">Longitud *</label>
                            <input type="number" id="longitud" name="longitud" step="any" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="fechaEvento">Fecha del Evento</label>
                        <input type="datetime-local" id="fechaEvento" name="fechaEvento">
                    </div>

                    <div class="form-group">
                        <label for="descripcion">Descripci√≥n del Evento *</label>
                        <textarea id="descripcion" name="descripcion" rows="3" required placeholder="Describe las caracter√≠sticas del evento, da√±os, causas aparentes..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="factorDesencadenante">Factor Desencadenante</label>
                        <select id="factorDesencadenante" name="factorDesencadenante">
                            <option value="">Seleccionar factor</option>
                            <option value="precipitacion">üåßÔ∏è Precipitaci√≥n Intensa</option>
                            <option value="sismo">üåç Actividad S√≠smica</option>
                            <option value="antropico">üë• Actividad Humana</option>
                            <option value="erosion_fluvial">üèûÔ∏è Erosi√≥n Fluvial</option>
                            <option value="volcanico">üåã Actividad Volc√°nica</option>
                            <option value="desconocido">‚ùì Desconocido</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="nivelRiesgo">Nivel de Riesgo *</label>
                        <select id="nivelRiesgo" name="nivelRiesgo" required>
                            <option value="bajo">üü¢ Bajo</option>
                            <option value="medio" selected>üü° Medio</option>
                            <option value="alto">üî¥ Alto</option>
                            <option value="muy_alto">üÜò Muy Alto</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="afectaciones">Afectaciones</label>
                        <textarea id="afectaciones" name="afectaciones" rows="2" placeholder="Viviendas afectadas, v√≠as interrumpidas, servicios p√∫blicos..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="reportadoPor">Reportado por</label>
                        <input type="text" id="reportadoPor" name="reportadoPor" placeholder="Nombre del t√©cnico/inspector">
                    </div>

                    <div class="form-group">
                        <label for="institucion">Instituci√≥n</label>
                        <input type="text" id="institucion" name="institucion" placeholder="Entidad que reporta">
                    </div>

                    <div class="form-group">
                        <label>Archivos t√©cnicos (fotos, informes, an√°lisis)</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="archivos" name="archivos" multiple accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.dwg">
                            <label for="archivos" class="file-input-label">
                                <i class="fas fa-upload"></i> Seleccionar Archivos
                            </label>
                        </div>
                        <div id="file-info" class="file-info" style="display: none;"></div>
                    </div>

                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i> Enviar Reporte
                    </button>

                    <div id="status-message" class="status-message"></div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        let map;
        let currentMarker;
        let reportes = [];
        let layerGroups = {};
        let heatmapVisible = false;

        // Datos simulados para las capas
        const datosCapas = {
            deslizamiento1999_2003: generateRandomSlides(50, '1999-2003'),
            deslizamiento2003_2010: generateRandomSlides(40, '2003-2010'),
            deslizamiento2010_2015: generateRandomSlides(35, '2010-2015'),
            litologia: generateLitologyData(),
            urbano_dicf: generateUrbanAreas()
        };

        function generateRandomSlides(count, period) {
            const slides = [];
            for (let i = 0; i < count; i++) {
                slides.push({
                    lat: -4.0 + (Math.random() - 0.5) * 0.1,
                    lng: -79.2 + (Math.random() - 0.5) * 0.1,
                    tipo: ['deslizamiento', 'derrumbe', 'flujo_detritos'][Math.floor(Math.random() * 3)],
                    magnitud: ['peque√±o', 'mediano', 'grande'][Math.floor(Math.random() * 3)],
                    periodo: period,
                    fecha: generateRandomDate(period)
                });
            }
            return slides;
        }

        function generateRandomDate(period) {
            const [start, end] = period.split('-');
            const startYear = parseInt(start);
            const endYear = parseInt(end);
            const year = startYear + Math.floor(Math.random() * (endYear - startYear + 1));
            const month = Math.floor(Math.random() * 12) + 1;
            const day = Math.floor(Math.random() * 28) + 1;
            return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }

        function generateLitologyData() {
            return [
                { lat: -4.02, lng: -79.22, tipo: 'Arenisca', resistencia: 'Media' },
                { lat: -3.98, lng: -79.18, tipo: 'Lutita', resistencia: 'Baja' },
                { lat: -4.01, lng: -79.21, tipo: 'Conglomerado', resistencia: 'Alta' }
            ];
        }

        function generateUrbanAreas() {
            return [
                { lat: -4.0, lng: -79.2, nombre: 'Centro Zamora', poblacion: 15000 },
                { lat: -3.99, lng: -79.19, nombre: 'Barrio Norte', poblacion: 8000 }
            ];
        }

        function initMap() {
            map = L.map('map').setView([-4.0, -79.2], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Inicializar grupos de capas
            Object.keys(datosCapas).forEach(layerName => {
                layerGroups[layerName] = L.layerGroup();
            });

            // Eventos del mapa
            map.on('click', function(e) {
                addMarker(e.latlng.lat, e.latlng.lng);
                analyzeLocation(e.latlng.lat, e.latlng.lng);
            });

            // Configurar controles de capas
            setupLayerControls();
        }

        function setupLayerControls() {
            document.querySelectorAll('.layer-toggle').forEach(toggle => {
                const checkbox = toggle.querySelector('input[type="checkbox"]');
                const layerName = toggle.dataset.layer;
                
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        loadLayer(layerName);
                        toggle.classList.add('active');
                    } else {
                        unloadLayer(layerName);
                        toggle.classList.remove('active');
                    }
                });
            });
        }

        function loadLayer(layerName) {
            const data = datosCapas[layerName];
            layerGroups[layerName].clearLayers();

            data.forEach(item => {
                let marker;
                let color = '#ff4444';
                
                switch(layerName) {
                    case 'deslizamiento1999_2003':
                        color = '#ff6b6b';
                        break;
                    case 'deslizamiento2003_2010':
                        color = '#ffa500';
                        break;
                    case 'deslizamiento2010_2015':
                        color = '#ff4444';
                        break;
                    case 'litologia':
                        color = '#8e44ad';
                        break;
                    case 'urbano_dicf':
                        color = '#3498db';
                        break;
                }

                marker = L.circleMarker([item.lat, item.lng], {
                    color: color,
                    fillColor: color,
                    fillOpacity:
